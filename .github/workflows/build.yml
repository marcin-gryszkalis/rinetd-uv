name: Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-24.04-arm # linux arm64
          - ubuntu-latest    # linux x86_64
          - macos-latest     # macos arm64
          - macos-15-intel   # macos x86_64
        compiler: [ gcc, clang ]

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install build tools (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config libuv1-dev peg ccache

      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: |
          # Suppress all 3 lines of each warning: "libuv 1.51.0 is already installed and up-to-date. To reinstall 1.51.0, run: brew reinstall libuv"
          brew install --quiet autoconf automake libtool pkg-config peg libuv ccache

      - name: Restore ccache cache
        if: runner.os != 'Windows'
        uses: actions/cache@v5
        with:
          path: ~/.cache/ccache
          key: ccache-${{ runner.os }}-${{ matrix.compiler }}-${{ hashFiles('configure.ac', 'Makefile.am', 'src/**/*.c', 'src/**/*.h') }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.compiler }}-

      - name: Log platform and compiler
        run: |
          CC=${{ matrix.compiler }}
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            os_name=$(grep "^NAME=" /etc/os-release | sed -E 's/^NAME="([^"]+)"/\1/' | tr -d '"')
            os_version=$(grep "^VERSION=" /etc/os-release | sed -E 's/^VERSION="([^"]+).*/\1/' | tr -d '"')
            echo "Platform: $os_name $os_version ($(uname -m))"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            # Fix gcc on macOS (homebrew installs numbered commands like "gcc-15", while gcc is pointing to clang)
            if [[ "$CC" == "gcc" ]]; then
              CC=$(brew list gcc | grep "/bin/gcc-\d" | sort -V | tail -1 | xargs basename)
            fi
            echo "Platform: macOS $(sw_vers -productVersion) ($(uname -m))"
          fi
          echo "Compiler: $($CC --version | head -1)"
          echo "CC=$CC" >> $GITHUB_ENV
          echo "BASE_CC=$CC" >> $GITHUB_ENV

      - name: Configure compiler cache
        if: runner.os != 'Windows'
        run: |
          mkdir -p "$HOME/.cache/ccache"
          ccache --max-size=500M
          ccache --zero-stats
          echo "CCACHE_DIR=$HOME/.cache/ccache" >> $GITHUB_ENV
          echo "CCACHE_BASEDIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - run: autoreconf -fvi

      - name: Configure build with ${{ matrix.compiler }}
        run: |
          export CC="ccache $BASE_CC"
          ./configure --prefix=$HOME/local

      - name: Compile
        run: |
          export VERBOSE=1
          export CC="ccache $BASE_CC"
          make

      - name: ccache stats
        if: runner.os != 'Windows'
        run: ccache --show-stats

      - name: Check build
        run: src/rinetd-uv --version

  windows-msvc:
    if: false
    runs-on: windows-latest
    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Determine vcpkg path
        id: vcpkg-path
        run: |
          $root = Join-Path "${{ runner.temp }}" "vcpkg"
          "VCPKG_ROOT=$root" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          "root=$root" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Restore vcpkg cache
        uses: actions/cache@v5
        with:
          path: ${{ steps.vcpkg-path.outputs.root }}
          key: vcpkg-${{ runner.os }}-${{ env.VCPKG_DEFAULT_TRIPLET }}-${{ hashFiles('rinetd.vcxproj', '.github/workflows/build.yml') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-${{ env.VCPKG_DEFAULT_TRIPLET }}-

      - name: Install libuv
        run: |
          if (-not (Test-Path "$env:VCPKG_ROOT\.git")) {
            git clone https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
          } else {
            git -C $env:VCPKG_ROOT pull
          }
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics
          & "$env:VCPKG_ROOT\vcpkg.exe" install libuv

      - name: Enable vcpkg integration
        run: |
          & "$env:VCPKG_ROOT\vcpkg.exe" integrate install

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build (Release x64)
        run: |
          msbuild rinetd.vcxproj /m /p:Configuration=Release /p:Platform=x64 /p:VcpkgTriplet=x64-windows

      - name: Check build
        run: |
          $env:PATH = "$env:VCPKG_ROOT\installed\x64-windows\bin;$env:PATH"
          if (-not (Test-Path -Path "x64\Release\rinetd.exe")) { throw "rinetd.exe not found" }
          & "x64\Release\rinetd.exe" --version
