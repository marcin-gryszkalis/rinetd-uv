# rinetd-uv.yaml - example configuration with load balancing

global:
  # Logging
  log_file: /var/log/rinetd-uv.log
  # log_common: false       # Apache-style logging (default: false)

  # PID file (default: /var/run/rinetd-uv.pid)
  pid_file: /var/run/rinetd-uv.pid

  # Buffer size (1024-1048576, default: 65536)
  buffer_size: 65536

  # Buffer pool configuration
  pool_min_free: 64         # Min buffers to keep (0-10000, default: 64)
  pool_max_free: 1024       # Max buffers before trimming (1-100000, default: 1024)
  pool_trim_delay: 60000    # Trim delay in milliseconds (100-300000, default: 60000)

  # DNS configuration
  dns_refresh: 600          # DNS refresh interval in seconds (default: 600)
  dns_multi_ip_expand: true # Expand multi-IP DNS to backends (default: true for YAML)
  dns_multi_ip_proto: ipv4  # ipv4, ipv6, or any (default: ipv4)

  # Network settings
  listen_backlog: 128       # TCP listen backlog (1-65535, default: 128)
  max_udp_connections: 5000 # Max UDP connections per rule (1-1000000, default: 5000)

  # Status reporting
  status:
    enabled: true
    file: /var/log/rinetd-uv_status.json
    interval: 30            # Write interval in seconds (default: 30)
    format: json            # json or text (default: json)
  stats_log_interval: 60    # Log summary interval, 0 to disable (default: 60)

rules:
  # Simple 1:1 forwarding (equivalent to legacy format)
  - name: simple-forward
    bind: "0.0.0.0:80/tcp"
    connect: "192.168.1.10:8080"

  # Load balanced web servers with weighted round-robin
  - name: web-cluster
    bind:
      - "0.0.0.0:443/tcp"
      - "[::]:443/tcp"
    connect:
      - dest: "web1.internal:8443"
        weight: 3
      - dest: "web2.internal:8443"
        weight: 2
      - dest: "web3.internal:8443"
        weight: 1
    load_balancing:
      algorithm: roundrobin
      health_threshold: 3
      recovery_timeout: 30
    access:
      allow: ["10.*", "192.168.*"]
      deny: ["*"]

  # DNS servers with least-connections algorithm
  - name: dns-lb
    bind: "0.0.0.0:53/udp"
    connect:
      - dest: "8.8.8.8:53/udp"
      - dest: "8.8.4.4:53/udp"
      - dest: "1.1.1.1:53/udp"
    load_balancing:
      algorithm: leastconn
    timeout: 10

  # Application servers with sticky sessions
  - name: app-cluster
    bind: "0.0.0.0:8080/tcp"
    connect:
      - dest: "app1.internal:3000"
        dns_refresh: 60
      - dest: "app2.internal:3000"
        dns_refresh: 60
    load_balancing:
      algorithm: iphash
      affinity_ttl: 3600
      affinity_max_entries: 50000
    keepalive: true

  # Docker socket proxy
  - name: docker-proxy
    bind: "0.0.0.0:2375/tcp"
    connect: "unix:/var/run/docker.sock"
    access:
      allow: ["10.0.0.*"]
      deny: ["*"]
